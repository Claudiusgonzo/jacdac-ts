<html>

<head>
    <style>
        body {
            font-family: monospace;
        }

        #streams {
            margin-top: 1rem;
        }

        .stream input {
            margin-left: 1rem;
        }

        #log {
            margin-top: 1rem;
        }

        #log>div {
            margin: 0.25rem;
        }
    </style>
</head>

<body>
    <h1>JACDAC/Streaming</h1>
    <div>
        <button id="connect">connect to jacdac device</button>
    </div>
    <div id="devices" class="segment"></div>
    <div id="streams" class="segment"></div>

    <script src="https://cdn.jsdelivr.net/npm/jacdac-ts"></script>
    <script>
        const devicesDiv = document.getElementById("devices");
        async function sniff() {
            console.log('starting')
            let bus = await jacdac.requestUSBBus();
            bus.on('deviceannounce', d => {
                // if the device is a sensor, start streaming
                const sensor = jacdac.SensorClient.fromFirstServiceClass(d, jacdac.JD_SERVICE_SLIDER);
                if (sensor) {
                    console.log(`start streaming ${d}: ${jacdac.printServices(d)}`)
                    sensor.setStreamingAsync(true);
                }
            })
            bus.on('packetsend', pkt => {
                console.log(jacdac.printPacket(pkt));
            })
            bus.on('packetreceive', pkt => {
                const decoded = jacdac.decodePacketData(pkt);
                if (decoded)
                    slider(pkt)
            })
            console.log('started')
        }

        const connect = document.getElementById("connect");
        connect.onclick = sniff;

        function slider(pkt) {
            let el = document.getElementById(pkt.device_identifier);
            if (!el) {
                const div = document.createElement("div")
                div.className = "stream"
                el = document.createElement("input");
                el.id = pkt.device_identifier
                el.type = "range"
                el.min = 0
                el.max = 1
                el.readonly = true
                const label = document.createElement("label")
                label.id = el.id + ":label"
                label.for = el.id
                div.append(label)
                div.append(el)
                const streams = document.getElementById("streams")
                streams.append(div)
            }

            const v = jacdac.intOfBuffer(pkt.data);
            el.max = Math.max(parseInt(el.max), v)
            el.value = v;

            const lbl = document.getElementById(el.id + ":label");
            lbl.innerText = `${pkt.dev.shortId}: ${v}`;
        }
    </script>
</body>

</html>