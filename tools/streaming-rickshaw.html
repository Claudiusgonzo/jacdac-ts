<html>

<head>
    <style>
        body {
            font-family: monospace;
        }

        .graph {
            margin: 0.25rem;
        }
    </style>
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/rickshaw/rickshaw.min.css">

    <script src="https://cdn.jsdelivr.net/npm/d3@3.5.16/d3.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/rickshaw/rickshaw.min.js"></script>
</head>

<body>
    <h1>JACDAC/Streaming-Rickshaw</h1>
    <div>
        <button id="connect">connect to jacdac device</button>
    </div>
    <div class="hint"><a href="https://tech.shutterstock.com/rickshaw/">Rickshaw</a> is a javascript charting library.
    </div>
    <div id="graphs">
    </div>
    <script src="/dist/jacdac.umd.js"></script>
    <script>
        const graphs = document.getElementById("graphs");
        async function sniff() {
            console.log('starting')
            let bus = await jacdac.requestUSBBus();
            bus.on('deviceannounce', d => {
                // tell all services to start streaming, ignored if not supported
                for (let i = 1; i < d.serviceLength; ++i) {
                    const sensor = new jacdac.SensorClient(d, i)
                    sensor.setStreamingAsync(true);
                }
            })
            bus.on('packetsend', pkt => {
                console.log(jacdac.printPacket(pkt));
            })
            bus.on('packetreceive', pkt => {
                const decoded = jacdac.decodePacketData(pkt);
                if (decoded)
                    graph(pkt)
            })
            console.log('started')
        }

        const connect = document.getElementById("connect");
        connect.onclick = sniff;

        const palette = new Rickshaw.Color.Palette();
        function graph(pkt) {
            const serviceClass = pkt.dev.serviceClassAt(pkt.service_number);
            const id = serviceClass;
            let div = document.getElementById(id);

            // create graph
            if (!div) {
                const container = document.createElement("div")
                const legendDiv = document.createElement("div")
                container.append(legendDiv)
                div = document.createElement("div")
                div.className = "graph"
                div.id = id;
                container.append(div)

                div.graph = new Rickshaw.Graph({
                    element: div,
                    renderer: 'line',
                    width: 1080,
                    interpolation: "step-after",
                    series: [
                    ]
                });
                div.legend = new Rickshaw.Graph.Legend({
                    graph: div.graph,
                    element: legendDiv
                });
                const xAxis = new Rickshaw.Graph.Axis.Time({
                    graph: div.graph
                });
                xAxis.render();
                const yAxis = new Rickshaw.Graph.Axis.Y({
                    graph: div.graph
                });
                yAxis.render();

                const hoverDetail = new Rickshaw.Graph.HoverDetail({
                    graph: div.graph,
                    xFormatter: function (x) { return x + "s" },
                    yFormatter: function (y) { return y }
                });
                graphs.append(container)
            }

            // create serie
            const serieName = `${pkt.dev.shortId}/${jacdac.serviceName(serviceClass)}`;
            let serie = div.graph.series.find(serie => serie.name === serieName);
            if (!serie) {
                serie = {
                    name: serieName,
                    color: palette.color(),
                    data: []
                }
                div.graph.series.push(serie);
                div.legend.render();
            }

            // inject data
            const v = jacdac.intOfBuffer(pkt.data);
            const data = serie.data;
            data.push({ x: pkt.timestamp / 1000.0, y: v })
            if (data.length > 40) data.shift()

            div.graph.render();
        }
    </script>
</body>

</html>