{"version":3,"file":"jacdac.es5.js","sources":["../src/constants.ts","../src/utils.ts","../src/packet.ts","../src/device.ts","../src/hf2.ts","../src/pretty.ts"],"sourcesContent":["\r\n// Registers 0x001-0x07f - r/w common to all services\r\n// Registers 0x080-0x0ff - r/w defined per-service\r\n// Registers 0x100-0x17f - r/o common to all services\r\n// Registers 0x180-0x1ff - r/o defined per-service\r\n// Registers 0x200-0xeff - custom, defined per-service\r\n// Registers 0xf00-0xfff - reserved for implementation, should not be on the wire\r\n\r\n// this is either binary (0 or non-zero), or can be gradual (eg. brightness of neopixel)\r\nexport const REG_INTENSITY = 0x01\r\n// the primary value of actuator (eg. servo angle)\r\nexport const REG_VALUE = 0x02\r\n// enable/disable streaming\r\nexport const REG_IS_STREAMING = 0x03\r\n// streaming interval in miliseconds\r\nexport const REG_STREAMING_INTERVAL = 0x04\r\n// for analog sensors\r\nexport const REG_LOW_THRESHOLD = 0x05\r\nexport const REG_HIGH_THRESHOLD = 0x06\r\n// limit power drawn; in mA\r\nexport const REG_MAX_POWER = 0x07\r\n\r\n// eg. one number for light sensor, all 3 coordinates for accelerometer\r\nexport const REG_READING = 0x101\r\n\r\nexport const CMD_GET_REG = 0x1000\r\nexport const CMD_SET_REG = 0x2000\r\n\r\nexport const CMD_TOP_MASK = 0xf000\r\nexport const CMD_REG_MASK = 0x0fff\r\n\r\n\r\n// Commands 0x000-0x07f - common to all services\r\n// Commands 0x080-0xeff - defined per-service\r\n// Commands 0xf00-0xfff - reserved for implementation\r\n// enumeration data for CTRL, ad-data for other services\r\nexport const CMD_ADVERTISEMENT_DATA = 0x00\r\n// event from sensor or on broadcast service\r\nexport const CMD_EVENT = 0x01\r\n// request to calibrate sensor\r\nexport const CMD_CALIBRATE = 0x02\r\n// request human-readable description of service\r\nexport const CMD_GET_DESCRIPTION = 0x03\r\n\r\n// Commands specific to control service\r\n// do nothing\r\nexport const CMD_CTRL_NOOP = 0x80\r\n// blink led or otherwise draw user's attention\r\nexport const CMD_CTRL_IDENTIFY = 0x81\r\n// reset device\r\nexport const CMD_CTRL_RESET = 0x82\r\n\r\nexport const STREAM_PORT_SHIFT = 7\r\nexport const STREAM_COUNTER_MASK = 0x001f\r\nexport const STREAM_CLOSE_MASK = 0x0020\r\nexport const STREAM_METADATA_MASK = 0x0040\r\n\r\nexport const JD_SERIAL_HEADER_SIZE = 16\r\nexport const JD_SERIAL_MAX_PAYLOAD_SIZE = 236\r\nexport const JD_SERVICE_NUMBER_MASK = 0x3f\r\nexport const JD_SERVICE_NUMBER_INV_MASK = 0xc0\r\nexport const JD_SERVICE_NUMBER_CRC_ACK = 0x3f\r\nexport const JD_SERVICE_NUMBER_STREAM = 0x3e\r\nexport const JD_SERVICE_NUMBER_CTRL = 0x00\r\n\r\n// the COMMAND flag signifies that the device_identifier is the recipent\r\n// (i.e., it's a command for the peripheral); the bit clear means device_identifier is the source\r\n// (i.e., it's a report from peripheral or a broadcast message)\r\nexport const JD_FRAME_FLAG_COMMAND = 0x01\r\n// an ACK should be issued with CRC of this package upon reception\r\nexport const JD_FRAME_FLAG_ACK_REQUESTED = 0x02\r\n// the device_identifier contains target service class number\r\nexport const JD_FRAME_FLAG_IDENTIFIER_IS_SERVICE_CLASS = 0x04\r\n","export function error(msg: string) {\r\n    throw new Error(msg)\r\n}\r\n\r\nexport function log(msg: string, v?: any) {\r\n    if (v === undefined)\r\n        console.log(\"JD: \" + msg)\r\n    else\r\n        console.log(\"JD: \" + msg, v)\r\n}\r\n\r\nexport function warn(msg: string, v?: any) {\r\n    if (v === undefined)\r\n        console.log(\"JD-WARN: \" + msg)\r\n    else\r\n        console.log(\"JD-WARN: \" + msg, v)\r\n}\r\n\r\nexport function delay<T>(millis: number, value?: T): Promise<T> {\r\n    return new Promise((resolve) => setTimeout(() => resolve(value), millis))\r\n}\r\n\r\nexport function memcpy(trg: Uint8Array, trgOff: number, src: ArrayLike<number>, srcOff?: number, len?: number) {\r\n    if (srcOff === void 0)\r\n        srcOff = 0\r\n    if (len === void 0)\r\n        len = src.length - srcOff\r\n    for (let i = 0; i < len; ++i)\r\n        trg[trgOff + i] = src[srcOff + i]\r\n}\r\n\r\nexport function bufferEq(a: Uint8Array, b: ArrayLike<number>) {\r\n    if (a == b)\r\n        return true\r\n    if (!a || !b || a.length != b.length)\r\n        return false\r\n    for (let i = 0; i < a.length; ++i) {\r\n        if (a[i] != b[i]) return false\r\n    }\r\n    return true\r\n}\r\n\r\n\r\nexport function hash(buf: Uint8Array, bits: number) {\r\n    bits |= 0\r\n    if (bits < 1)\r\n        return 0\r\n    const h = fnv1(buf)\r\n    if (bits >= 32)\r\n        return h >>> 0\r\n    else\r\n        return ((h ^ (h >>> bits)) & ((1 << bits) - 1)) >>> 0\r\n}\r\n\r\nexport function idiv(a: number, b: number) { return ((a | 0) / (b | 0)) | 0 }\r\nexport function fnv1(data: Uint8Array) {\r\n    let h = 0x811c9dc5\r\n    for (let i = 0; i < data.length; ++i) {\r\n        h = Math.imul(h, 0x1000193) ^ data[i]\r\n    }\r\n    return h\r\n}\r\n\r\nexport function crc(p: Uint8Array) {\r\n    let crc = 0xffff;\r\n    for (let i = 0; i < p.length; ++i) {\r\n        const data = p[i];\r\n        let x = (crc >> 8) ^ data;\r\n        x ^= x >> 4;\r\n        crc = (crc << 8) ^ (x << 12) ^ (x << 5) ^ x;\r\n        crc &= 0xffff;\r\n    }\r\n    return crc;\r\n}\r\n\r\nexport function ALIGN(n: number) { return (n + 3) & ~3 }\r\n\r\n// this will take lower 8 bits from each character\r\nexport function stringToUint8Array(input: string) {\r\n    let len = input.length;\r\n    let res = new Uint8Array(len)\r\n    for (let i = 0; i < len; ++i)\r\n        res[i] = input.charCodeAt(i) & 0xff;\r\n    return res;\r\n}\r\n\r\nexport function uint8ArrayToString(input: ArrayLike<number>) {\r\n    let len = input.length;\r\n    let res = \"\"\r\n    for (let i = 0; i < len; ++i)\r\n        res += String.fromCharCode(input[i]);\r\n    return res;\r\n}\r\n\r\n\r\nexport function fromUTF8(binstr: string) {\r\n    if (!binstr) return \"\"\r\n\r\n    // escape function is deprecated\r\n    let escaped = \"\"\r\n    for (let i = 0; i < binstr.length; ++i) {\r\n        let k = binstr.charCodeAt(i) & 0xff\r\n        if (k == 37 || k > 0x7f) {\r\n            escaped += \"%\" + k.toString(16);\r\n        } else {\r\n            escaped += binstr.charAt(i)\r\n        }\r\n    }\r\n\r\n    // decodeURIComponent does the actual UTF8 decoding\r\n    return decodeURIComponent(escaped)\r\n}\r\n\r\nexport function toUTF8(str: string, cesu8?: boolean) {\r\n    let res = \"\";\r\n    if (!str) return res;\r\n    for (let i = 0; i < str.length; ++i) {\r\n        let code = str.charCodeAt(i);\r\n        if (code <= 0x7f) res += str.charAt(i);\r\n        else if (code <= 0x7ff) {\r\n            res += String.fromCharCode(0xc0 | (code >> 6), 0x80 | (code & 0x3f));\r\n        } else {\r\n            if (!cesu8 && 0xd800 <= code && code <= 0xdbff) {\r\n                let next = str.charCodeAt(++i);\r\n                if (!isNaN(next))\r\n                    code = 0x10000 + ((code - 0xd800) << 10) + (next - 0xdc00);\r\n            }\r\n\r\n            if (code <= 0xffff)\r\n                res += String.fromCharCode(0xe0 | (code >> 12), 0x80 | ((code >> 6) & 0x3f), 0x80 | (code & 0x3f));\r\n            else\r\n                res += String.fromCharCode(0xf0 | (code >> 18), 0x80 | ((code >> 12) & 0x3f), 0x80 | ((code >> 6) & 0x3f), 0x80 | (code & 0x3f));\r\n        }\r\n\r\n    }\r\n    return res;\r\n}\r\n\r\n\r\nexport interface SMap<T> {\r\n    [index: string]: T;\r\n}\r\n\r\nexport class PromiseBuffer<T> {\r\n    private waiting: ((v: (T | Error)) => void)[] = [];\r\n    private available: (T | Error)[] = [];\r\n\r\n    drain() {\r\n        for (let f of this.waiting) {\r\n            f(new Error(\"Promise Buffer Reset\"))\r\n        }\r\n        this.waiting = []\r\n        this.available = []\r\n    }\r\n\r\n\r\n    pushError(v: Error) {\r\n        this.push(v as any)\r\n    }\r\n\r\n    push(v: T) {\r\n        let f = this.waiting.shift()\r\n        if (f) f(v)\r\n        else this.available.push(v)\r\n    }\r\n\r\n    shiftAsync(timeout = 0) {\r\n        if (this.available.length > 0) {\r\n            let v = this.available.shift()\r\n            if (v instanceof Error)\r\n                return Promise.reject<T>(v)\r\n            else\r\n                return Promise.resolve<T>(v)\r\n        } else\r\n            return new Promise<T>((resolve, reject) => {\r\n                let f = (v: (T | Error)) => {\r\n                    if (v instanceof Error) reject(v)\r\n                    else resolve(v)\r\n                }\r\n                this.waiting.push(f)\r\n                if (timeout > 0) {\r\n                    delay(timeout)\r\n                        .then(() => {\r\n                            let idx = this.waiting.indexOf(f)\r\n                            if (idx >= 0) {\r\n                                this.waiting.splice(idx, 1)\r\n                                reject(new Error(\"Timeout\"))\r\n                            }\r\n                        })\r\n                }\r\n            })\r\n    }\r\n}\r\n\r\n\r\nexport class PromiseQueue {\r\n    promises: SMap<(() => Promise<any>)[]> = {};\r\n\r\n    enqueue<T>(id: string, f: () => Promise<T>): Promise<T> {\r\n        return new Promise<T>((resolve, reject) => {\r\n            let arr = this.promises[id]\r\n            if (!arr) {\r\n                arr = this.promises[id] = []\r\n            }\r\n            const cleanup = () => {\r\n                arr.shift()\r\n                if (arr.length == 0)\r\n                    delete this.promises[id]\r\n                else\r\n                    arr[0]()\r\n            }\r\n            arr.push(() =>\r\n                f().then(v => {\r\n                    cleanup()\r\n                    resolve(v)\r\n                }, err => {\r\n                    cleanup()\r\n                    reject(err)\r\n                }))\r\n            if (arr.length == 1)\r\n                arr[0]()\r\n        })\r\n    }\r\n}\r\n\r\nexport function toHex(bytes: ArrayLike<number>) {\r\n    let r = \"\"\r\n    for (let i = 0; i < bytes.length; ++i)\r\n        r += (\"0\" + bytes[i].toString(16)).slice(-2)\r\n    return r\r\n}\r\n\r\nexport function fromHex(hex: string) {\r\n    let r = new Uint8Array(hex.length >> 1)\r\n    for (let i = 0; i < hex.length; i += 2)\r\n        r[i >> 1] = parseInt(hex.slice(i, i + 2), 16)\r\n    return r\r\n}\r\n\r\nexport interface MutableArrayLike<T> {\r\n    readonly length: number;\r\n    [n: number]: T;\r\n}\r\n\r\nexport function write32(buf: MutableArrayLike<number>, pos: number, v: number) {\r\n    buf[pos + 0] = (v >> 0) & 0xff;\r\n    buf[pos + 1] = (v >> 8) & 0xff;\r\n    buf[pos + 2] = (v >> 16) & 0xff;\r\n    buf[pos + 3] = (v >> 24) & 0xff;\r\n}\r\n\r\nexport function write16(buf: MutableArrayLike<number>, pos: number, v: number) {\r\n    buf[pos + 0] = (v >> 0) & 0xff;\r\n    buf[pos + 1] = (v >> 8) & 0xff;\r\n}\r\n\r\nexport function read32(buf: ArrayLike<number>, pos: number) {\r\n    return (buf[pos] | (buf[pos + 1] << 8) | (buf[pos + 2] << 16) | (buf[pos + 3] << 24)) >>> 0\r\n}\r\n\r\nexport function read16(buf: ArrayLike<number>, pos: number) {\r\n    return buf[pos] | (buf[pos + 1] << 8)\r\n}\r\n\r\nexport function encodeU32LE(words: number[]) {\r\n    let r = new Uint8Array(words.length * 4)\r\n    for (let i = 0; i < words.length; ++i)\r\n        write32(r, i * 4, words[i])\r\n    return r\r\n}\r\n\r\nexport function decodeU32LE(buf: Uint8Array) {\r\n    let res: number[] = []\r\n    for (let i = 0; i < buf.length; i += 4)\r\n        res.push(read32(buf, i))\r\n    return res\r\n}\r\n\r\nexport const enum NumberFormat {\r\n    Int8LE = 1,\r\n    UInt8LE = 2,\r\n    Int16LE = 3,\r\n    UInt16LE = 4,\r\n    Int32LE = 5,\r\n    Int8BE = 6,\r\n    UInt8BE = 7,\r\n    Int16BE = 8,\r\n    UInt16BE = 9,\r\n    Int32BE = 10,\r\n    UInt32LE = 11,\r\n    UInt32BE = 12,\r\n    Float32LE = 13,\r\n    Float64LE = 14,\r\n    Float32BE = 15,\r\n    Float64BE = 16,\r\n}\r\n\r\nexport function getNumber(buf: ArrayLike<number>, fmt: NumberFormat, offset: number) {\r\n    switch (fmt) {\r\n        case NumberFormat.UInt8BE:\r\n        case NumberFormat.UInt8LE:\r\n            return buf[offset]\r\n        case NumberFormat.Int8BE:\r\n        case NumberFormat.Int8LE:\r\n            return (buf[offset] << 24) >> 24\r\n        case NumberFormat.UInt16LE:\r\n            return read16(buf, offset)\r\n        case NumberFormat.Int16LE:\r\n            return (read16(buf, offset) << 16) >> 16\r\n        case NumberFormat.UInt32LE:\r\n            return read32(buf, offset)\r\n        case NumberFormat.Int32LE:\r\n            return read32(buf, offset) >> 0\r\n        default:\r\n            throw new Error(\"unsupported fmt:\" + fmt)\r\n    }\r\n}\r\n\r\nexport function bufferToString(buf: Uint8Array) {\r\n    return fromUTF8(uint8ArrayToString(buf))\r\n}\r\n\r\nexport function bufferConcat(a: Uint8Array, b: Uint8Array) {\r\n    const r = new Uint8Array(a.length + b.length)\r\n    r.set(a, 0)\r\n    r.set(b, a.length)\r\n    return r\r\n}\r\n\r\nexport function jsonCopyFrom<T>(trg: T, src: T) {\r\n    let v = clone(src)\r\n    for (let k of Object.keys(src)) {\r\n        (trg as any)[k] = (v as any)[k]\r\n    }\r\n}\r\nexport function assert(cond: boolean, msg = \"Assertion failed\") {\r\n    if (!cond) {\r\n        debugger\r\n        throw new Error(msg)\r\n    }\r\n}\r\n\r\nexport function flatClone<T extends Object>(obj: T): T {\r\n    if (obj == null) return null\r\n    let r: any = {}\r\n    Object.keys(obj).forEach((k) => { r[k] = (obj as any)[k] })\r\n    return r;\r\n}\r\n\r\nexport function clone<T>(v: T): T {\r\n    if (v == null) return null\r\n    return JSON.parse(JSON.stringify(v))\r\n}\r\n\r\n","import { warn, crc, ALIGN, write16, bufferConcat, toHex, fromHex, error, read32, read16, NumberFormat, getNumber, write32 } from \"./utils\";\r\nimport {\r\n    JD_FRAME_FLAG_COMMAND,\r\n    JD_FRAME_FLAG_IDENTIFIER_IS_SERVICE_CLASS,\r\n    CMD_SET_REG,\r\n    JD_SERIAL_HEADER_SIZE,\r\n    JD_FRAME_FLAG_ACK_REQUESTED,\r\n    JD_SERVICE_NUMBER_MASK,\r\n    JD_SERVICE_NUMBER_INV_MASK,\r\n    JD_SERIAL_MAX_PAYLOAD_SIZE,\r\n} from \"./constants\";\r\nimport { Device, Bus } from \"./device\";\r\n\r\nexport class Packet {\r\n    _header: Uint8Array;\r\n    _data: Uint8Array;\r\n    timestamp: number\r\n    dev: Device\r\n\r\n    private constructor() { }\r\n\r\n    static fromBinary(buf: Uint8Array) {\r\n        const p = new Packet()\r\n        p._header = buf.slice(0, JD_SERIAL_HEADER_SIZE)\r\n        p._data = buf.slice(JD_SERIAL_HEADER_SIZE)\r\n        return p\r\n    }\r\n\r\n    static from(service_command: number, data: Uint8Array) {\r\n        const p = new Packet()\r\n        p._header = new Uint8Array(JD_SERIAL_HEADER_SIZE)\r\n        p.data = data\r\n        p.service_command = service_command\r\n        return p\r\n    }\r\n\r\n    static onlyHeader(service_command: number) {\r\n        return Packet.from(service_command, new Uint8Array(0))\r\n    }\r\n\r\n    toBuffer() {\r\n        return bufferConcat(this._header, this._data)\r\n    }\r\n\r\n    get device_identifier() {\r\n        return toHex(this._header.slice(4, 4 + 8))\r\n    }\r\n    set device_identifier(id: string) {\r\n        const idb = fromHex(id)\r\n        if (idb.length != 8)\r\n            error(\"Invalid id\")\r\n        this._header.set(idb, 4)\r\n    }\r\n\r\n    get frame_flags() { return this._header[3] }\r\n\r\n    get multicommand_class() {\r\n        if (this.frame_flags & JD_FRAME_FLAG_IDENTIFIER_IS_SERVICE_CLASS)\r\n            return read32(this._header, 4)\r\n        return undefined\r\n    }\r\n\r\n    get size(): number {\r\n        return this._header[12];\r\n    }\r\n\r\n    get requires_ack(): boolean {\r\n        return (this.frame_flags & JD_FRAME_FLAG_ACK_REQUESTED) ? true : false;\r\n    }\r\n    set requires_ack(ack: boolean) {\r\n        if (ack != this.requires_ack)\r\n            this._header[3] ^= JD_FRAME_FLAG_ACK_REQUESTED\r\n    }\r\n\r\n    get service_number(): number {\r\n        return this._header[13] & JD_SERVICE_NUMBER_MASK;\r\n    }\r\n    set service_number(service_number: number) {\r\n        if (service_number == null)\r\n            throw new Error(\"service_number not set\")\r\n        this._header[13] = (this._header[13] & JD_SERVICE_NUMBER_INV_MASK) | service_number;\r\n    }\r\n\r\n    get service_class(): number {\r\n        if (this.dev)\r\n            return this.dev.serviceAt(this.service_number)\r\n        return undefined\r\n    }\r\n\r\n    get crc(): number {\r\n        return read16(this._header, 0)\r\n    }\r\n\r\n    get service_command(): number {\r\n        return read16(this._header, 14)\r\n    }\r\n    set service_command(cmd: number) {\r\n        write16(this._header, 14, cmd)\r\n    }\r\n\r\n    get is_reg_set() {\r\n        return (this.service_command >> 12) == (CMD_SET_REG >> 12)\r\n    }\r\n\r\n    get is_reg_get() {\r\n        return (this.service_command >> 12) == (CMD_SET_REG >> 12)\r\n    }\r\n\r\n    get data(): Uint8Array {\r\n        return this._data\r\n    }\r\n\r\n    set data(buf: Uint8Array) {\r\n        if (buf.length > JD_SERIAL_MAX_PAYLOAD_SIZE)\r\n            throw Error(\"Too big\")\r\n        this._header[12] = buf.length\r\n        this._data = buf\r\n    }\r\n\r\n    get uintData() {\r\n        let buf = this._data\r\n        if (buf.length == 0)\r\n            return undefined\r\n        if (buf.length < 4)\r\n            buf = bufferConcat(buf, new Uint8Array(4))\r\n        return read32(buf, 0)\r\n    }\r\n\r\n    get intData() {\r\n        let fmt: NumberFormat\r\n        switch (this._data.length) {\r\n            case 0:\r\n                return undefined\r\n            case 1:\r\n                fmt = NumberFormat.Int8LE\r\n                break\r\n            case 2:\r\n            case 3:\r\n                fmt = NumberFormat.Int16LE\r\n                break\r\n            default:\r\n                fmt = NumberFormat.Int32LE\r\n                break\r\n        }\r\n        return this.getNumber(fmt, 0)\r\n    }\r\n\r\n    compress(stripped: Uint8Array[]) {\r\n        if (stripped.length == 0)\r\n            return\r\n        let sz = -4\r\n        for (let s of stripped) {\r\n            sz += s.length\r\n        }\r\n        const data = new Uint8Array(sz)\r\n        this._header.set(stripped[0], 12)\r\n        data.set(stripped[0].slice(4), 0)\r\n        sz = stripped[0].length - 4\r\n        for (let s of stripped.slice(1)) {\r\n            data.set(s, sz)\r\n            sz += s.length\r\n        }\r\n        this._data = data\r\n    }\r\n\r\n    withFrameStripped() {\r\n        return bufferConcat(this._header.slice(12, 12 + 4), this._data)\r\n    }\r\n\r\n    getNumber(fmt: NumberFormat, offset: number) {\r\n        return getNumber(this._data, fmt, offset)\r\n    }\r\n\r\n    get is_command() {\r\n        return !!(this.frame_flags & JD_FRAME_FLAG_COMMAND)\r\n    }\r\n\r\n    get is_report() {\r\n        return !this.is_command\r\n    }\r\n\r\n    toString(): string {\r\n        let msg = `${this.device_identifier}/${this.service_number}[${this.frame_flags}]: ${this.service_command} sz=${this.size}`\r\n        if (this.size < 20) msg += \": \" + toHex(this.data)\r\n        else msg += \": \" + toHex(this.data.slice(0, 20)) + \"...\"\r\n        return msg\r\n    }\r\n\r\n    sendCoreAsync(bus: Bus) {\r\n        this._header[2] = this.size + 4\r\n        write16(this._header, 0, crc(bufferConcat(this._header.slice(2), this._data)))\r\n        return bus.sendPacket(this)\r\n    }\r\n\r\n    sendReportAsync(dev: Device) {\r\n        if (!dev)\r\n            return Promise.resolve()\r\n        this.device_identifier = dev.deviceId\r\n        return this.sendCoreAsync(dev.bus)\r\n    }\r\n\r\n    sendCmdAsync(dev: Device) {\r\n        if (!dev)\r\n            return Promise.resolve()\r\n        this.device_identifier = dev.deviceId\r\n        this._header[3] |= JD_FRAME_FLAG_COMMAND\r\n        return this.sendCoreAsync(dev.bus)\r\n    }\r\n\r\n    sendAsMultiCommandAsync(bus: Bus, service_class: number) {\r\n        this._header[3] |= JD_FRAME_FLAG_IDENTIFIER_IS_SERVICE_CLASS | JD_FRAME_FLAG_COMMAND\r\n        write32(this._header, 4, service_class)\r\n        write32(this._header, 8, 0)\r\n        return this.sendCoreAsync(bus)\r\n    }\r\n\r\n    static fromFrame(frame: Uint8Array, timestamp: number) {\r\n        return frameToPackets(frame, timestamp)\r\n    }\r\n}\r\n\r\n\r\nfunction frameToPackets(frame: Uint8Array, timestamp: number) {\r\n    const size = frame[2] || 0\r\n    if (frame.length < size + 12) {\r\n        warn(`${timestamp}ms: got only ${frame.length} bytes; expecting ${size + 12}`)\r\n    } else if (size < 4) {\r\n        warn(`${timestamp}ms: empty packet`)\r\n    } else {\r\n        const computed = crc(frame.slice(2, size + 12))\r\n        const actual = read16(frame, 0)\r\n        if (actual != computed)\r\n            console.log(`crc mismatch; sz=${size} got:${actual}, exp:${computed}`)\r\n\r\n        const res: Packet[] = []\r\n        if (frame.length != 12 + frame[2])\r\n            warn(`${timestamp}ms: unexpected packet len: ${frame.length}`)\r\n        for (let ptr = 12; ptr < 12 + frame[2];) {\r\n            const psz = frame[ptr] + 4\r\n            const sz = ALIGN(psz)\r\n            const pkt = bufferConcat(frame.slice(0, 12), frame.slice(ptr, ptr + psz))\r\n            if (ptr + sz > 12 + frame[2])\r\n                warn(`${timestamp}ms: invalid frame compression, res len=${res.length}`)\r\n            const p = Packet.fromBinary(pkt)\r\n            p.timestamp = timestamp\r\n            res.push(p)\r\n            ptr += sz\r\n        }\r\n\r\n        return res\r\n    }\r\n\r\n    return []\r\n}","import { Packet } from \"./packet\"\r\nimport { JD_SERVICE_NUMBER_CTRL, CMD_ADVERTISEMENT_DATA } from \"./constants\"\r\nimport { hash, fromHex, idiv, getNumber, NumberFormat, read32, SMap, bufferEq } from \"./utils\"\r\n\r\n/**\r\n * A JACDAC bus manager. This instance maintains the list of devices on the bus.\r\n */\r\nexport class Bus {\r\n    private devices_: Device[] = []\r\n    private deviceNames: SMap<string> = {}\r\n\r\n    /**\r\n     * Creates the bus with the given transport\r\n     * @param sendPacket \r\n     */\r\n    constructor(public sendPacket: (p: Packet) => Promise<void>) {\r\n    }\r\n\r\n    /**\r\n     * Gets the current list of known devices on the bus\r\n     */\r\n    getDevices() { return this.devices_.slice() }\r\n\r\n    /**\r\n     * Gets a device on the bus\r\n     * @param id \r\n     */\r\n    getDevice(id: string) {\r\n        let d = this.devices_.find(d => d.deviceId == id)\r\n        if (!d) {\r\n            d = new Device(this, id)\r\n            this.devices_.push(d);\r\n        }\r\n        return d\r\n    }\r\n\r\n\r\n    /**\r\n     * Ingests and process a packet received from the bus.\r\n     * @param pkt a jacdac packet\r\n     */\r\n    processPacket(pkt: Packet) {\r\n        if (pkt.multicommand_class) {\r\n            //\r\n        } else if (pkt.is_command) {\r\n            pkt.dev = this.getDevice(pkt.device_identifier)\r\n        } else {\r\n            const dev = pkt.dev = this.getDevice(pkt.device_identifier)\r\n            dev.lastSeen = pkt.timestamp\r\n\r\n            if (pkt.service_number == JD_SERVICE_NUMBER_CTRL) {\r\n                if (pkt.service_command == CMD_ADVERTISEMENT_DATA) {\r\n                    if (!bufferEq(pkt.data, dev.services)) {\r\n                        dev.services = pkt.data\r\n                        dev.lastServiceUpdate = pkt.timestamp\r\n                        // reattach(dev)\r\n                    }\r\n                }\r\n            }\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Tries to find the given device by id\r\n     * @param id \r\n     */\r\n    lookupName(id: string) {\r\n        return this.deviceNames[id];\r\n    }\r\n}\r\n\r\n\r\nexport class Device {\r\n    services: Uint8Array\r\n    lastSeen: number\r\n    lastServiceUpdate: number\r\n    currentReading: Uint8Array\r\n    private _shortId: string\r\n\r\n    constructor(public bus: Bus, public deviceId: string) {\r\n    }\r\n\r\n    get name() {\r\n        return this.bus.lookupName(this.deviceId) || this.bus.lookupName(this.shortId);\r\n    }\r\n\r\n    get shortId() {\r\n        // TODO measure if caching is worth it\r\n        if (!this._shortId)\r\n            this._shortId = shortDeviceId(this.deviceId)\r\n        return this._shortId;\r\n    }\r\n\r\n    toString() {\r\n        return this.shortId + (this.name ? ` (${this.name})` : ``)\r\n    }\r\n\r\n    hasService(service_class: number) {\r\n        for (let i = 4; i < this.services.length; i += 4)\r\n            if (getNumber(this.services, NumberFormat.UInt32LE, i) == service_class)\r\n                return true\r\n        return false\r\n    }\r\n\r\n    serviceAt(idx: number) {\r\n        idx <<= 2\r\n        if (!this.services || idx + 4 > this.services.length)\r\n            return undefined\r\n        return read32(this.services, idx)\r\n    }\r\n\r\n    sendCtrlCommand(cmd: number, payload: Buffer = null) {\r\n        const pkt = !payload ? Packet.onlyHeader(cmd) : Packet.from(cmd, payload)\r\n        pkt.service_number = JD_SERVICE_NUMBER_CTRL\r\n        pkt.sendCmdAsync(this)\r\n    }\r\n}\r\n\r\n\r\n// 4 letter ID; 0.04%/0.01%/0.002% collision probability among 20/10/5 devices\r\n// 3 letter ID; 1.1%/2.6%/0.05%\r\n// 2 letter ID; 25%/6.4%/1.5%\r\nexport function shortDeviceId(devid: string) {\r\n    const h = hash(fromHex(devid), 30)\r\n    return String.fromCharCode(0x41 + h % 26) +\r\n        String.fromCharCode(0x41 + idiv(h, 26) % 26) +\r\n        String.fromCharCode(0x41 + idiv(h, 26 * 26) % 26) +\r\n        String.fromCharCode(0x41 + idiv(h, 26 * 26 * 26) % 26)\r\n}","import * as U from \"./utils\"\r\n\r\nconst controlTransferGetReport = 0x01;\r\nconst controlTransferSetReport = 0x09;\r\nconst controlTransferOutReport = 0x200;\r\nconst controlTransferInReport = 0x100;\r\n\r\n// see https://github.com/microsoft/uf2/blob/master/hf2.md for full spec\r\nexport const HF2_CMD_BININFO = 0x0001 // no arguments\r\nexport const HF2_MODE_BOOTLOADER = 0x01\r\nexport const HF2_MODE_USERSPACE = 0x02\r\n/*\r\nstruct HF2_BININFO_Result {\r\n    uint32_t mode;\r\n    uint32_t flash_page_size;\r\n    uint32_t flash_num_pages;\r\n    uint32_t max_message_size;\r\n};\r\n*/\r\n\r\nexport const HF2_CMD_INFO = 0x0002\r\n// no arguments\r\n// results is utf8 character array\r\n\r\nexport const HF2_CMD_RESET_INTO_APP = 0x0003// no arguments, no result\r\n\r\nexport const HF2_CMD_RESET_INTO_BOOTLOADER = 0x0004  // no arguments, no result\r\n\r\nexport const HF2_CMD_START_FLASH = 0x0005   // no arguments, no result\r\n\r\nexport const HF2_CMD_WRITE_FLASH_PAGE = 0x0006\r\n/*\r\nstruct HF2_WRITE_FLASH_PAGE_Command {\r\n    uint32_t target_addr;\r\n    uint32_t data[flash_page_size];\r\n};\r\n*/\r\n// no result\r\n\r\nexport const HF2_CMD_CHKSUM_PAGES = 0x0007\r\n/*\r\nstruct HF2_CHKSUM_PAGES_Command {\r\n    uint32_t target_addr;\r\n    uint32_t num_pages;\r\n};\r\nstruct HF2_CHKSUM_PAGES_Result {\r\n    uint16_t chksums[num_pages];\r\n};\r\n*/\r\n\r\nexport const HF2_CMD_READ_WORDS = 0x0008\r\n/*\r\nstruct HF2_READ_WORDS_Command {\r\n    uint32_t target_addr;\r\n    uint32_t num_words;\r\n};\r\nstruct HF2_READ_WORDS_Result {\r\n    uint32_t words[num_words];\r\n};\r\n*/\r\n\r\nexport const HF2_CMD_WRITE_WORDS = 0x0009\r\n/*\r\nstruct HF2_WRITE_WORDS_Command {\r\n    uint32_t target_addr;\r\n    uint32_t num_words;\r\n    uint32_t words[num_words];\r\n};\r\n*/\r\n// no result\r\n\r\nexport const HF2_CMD_DMESG = 0x0010\r\n// no arguments\r\n// results is utf8 character array\r\n\r\nexport const HF2_FLAG_SERIAL_OUT = 0x80\r\nexport const HF2_FLAG_SERIAL_ERR = 0xC0\r\nexport const HF2_FLAG_CMDPKT_LAST = 0x40\r\nexport const HF2_FLAG_CMDPKT_BODY = 0x00\r\nexport const HF2_FLAG_MASK = 0xC0\r\nexport const HF2_SIZE_MASK = 63\r\n\r\nexport const HF2_STATUS_OK = 0x00\r\nexport const HF2_STATUS_INVALID_CMD = 0x01\r\nexport const HF2_STATUS_EXEC_ERR = 0x02\r\nexport const HF2_STATUS_EVENT = 0x80\r\n\r\n// the eventId is overlayed on the tag+status; the mask corresponds\r\n// to the HF2_STATUS_EVENT above\r\nexport const HF2_EV_MASK = 0x800000\r\n\r\nexport const HF2_CMD_JDS_CONFIG = 0x0020\r\nexport const HF2_CMD_JDS_SEND = 0x0021\r\nexport const HF2_EV_JDS_PACKET = 0x800020\r\n\r\nexport class Transport {\r\n    dev: USBDevice;\r\n    iface: USBInterface;\r\n    altIface: USBAlternateInterface;\r\n    epIn: USBEndpoint;\r\n    epOut: USBEndpoint;\r\n    readLoopStarted = false;\r\n    ready = false;\r\n\r\n    constructor(private requestDevice: (options: USBDeviceRequestOptions) => Promise<USBDevice>) {\r\n\r\n    }\r\n\r\n    onData = (v: Uint8Array) => { };\r\n    onError = (e: Error) => {\r\n        console.error(\"HF2 error: \" + (e ? e.stack : e))\r\n    };\r\n\r\n    log(msg: string, v?: any) {\r\n        if (v != undefined)\r\n            console.log(\"HF2: \" + msg, v)\r\n        else\r\n            console.log(\"HF2: \" + msg)\r\n    }\r\n\r\n\r\n    private clearDev() {\r\n        if (this.dev) {\r\n            this.dev = null\r\n            this.epIn = null\r\n            this.epOut = null\r\n        }\r\n    }\r\n\r\n    disconnectAsync() {\r\n        this.ready = false\r\n        if (!this.dev) return Promise.resolve()\r\n        this.log(\"close device\")\r\n        return this.dev.close()\r\n            .catch(e => {\r\n                // just ignore errors closing, most likely device just disconnected\r\n            })\r\n            .then(() => {\r\n                this.clearDev()\r\n                return U.delay(500)\r\n            })\r\n    }\r\n\r\n    private recvPacketAsync(): Promise<Uint8Array> {\r\n        let final = (res: USBInTransferResult) => {\r\n            if (res.status != \"ok\")\r\n                this.error(\"USB IN transfer failed\")\r\n            let arr = new Uint8Array(res.data.buffer)\r\n            if (arr.length == 0)\r\n                return this.recvPacketAsync()\r\n            return arr\r\n        }\r\n\r\n        if (!this.dev)\r\n            return Promise.reject(new Error(\"Disconnected\"))\r\n\r\n        if (!this.epIn) {\r\n            return this.dev.controlTransferIn({\r\n                requestType: \"class\",\r\n                recipient: \"interface\",\r\n                request: controlTransferGetReport,\r\n                value: controlTransferInReport,\r\n                index: this.iface.interfaceNumber\r\n            }, 64).then(final)\r\n        }\r\n\r\n        return this.dev.transferIn(this.epIn.endpointNumber, 64)\r\n            .then(final)\r\n    }\r\n\r\n    error(msg: string) {\r\n        throw new Error(`USB error on device ${this.dev ? this.dev.productName : \"n/a\"} (${msg})`)\r\n    }\r\n\r\n    private async readLoop() {\r\n        if (this.readLoopStarted)\r\n            return\r\n        this.readLoopStarted = true\r\n        this.log(\"start read loop\")\r\n\r\n        while (true) {\r\n            if (!this.ready) {\r\n                break\r\n                //await U.delay(300)\r\n                //continue\r\n            }\r\n\r\n            try {\r\n                const buf = await this.recvPacketAsync()\r\n\r\n                if (buf[0]) {\r\n                    // we've got data; retry reading immedietly after processing it\r\n                    this.onData(buf)\r\n                } else {\r\n                    // throttle down if no data coming\r\n                    await U.delay(5)\r\n                }\r\n            } catch (err) {\r\n                if (this.dev)\r\n                    this.onError(err)\r\n                await U.delay(300)\r\n            }\r\n        }\r\n    }\r\n\r\n    sendPacketAsync(pkt: Uint8Array) {\r\n        if (!this.dev)\r\n            return Promise.reject(new Error(\"Disconnected\"))\r\n        U.assert(pkt.length <= 64)\r\n        if (!this.epOut) {\r\n            return this.dev.controlTransferOut({\r\n                requestType: \"class\",\r\n                recipient: \"interface\",\r\n                request: controlTransferSetReport,\r\n                value: controlTransferOutReport,\r\n                index: this.iface.interfaceNumber\r\n            }, pkt).then(res => {\r\n                if (res.status != \"ok\")\r\n                    this.error(\"USB CTRL OUT transfer failed\")\r\n            })\r\n        }\r\n        return this.dev.transferOut(this.epOut.endpointNumber, pkt)\r\n            .then(res => {\r\n                if (res.status != \"ok\")\r\n                    this.error(\"USB OUT transfer failed\")\r\n            })\r\n    }\r\n\r\n\r\n    async init() {\r\n        this.dev = await this.requestDevice({ filters: [{}] })\r\n        this.iface = undefined;\r\n        this.altIface = undefined;\r\n        this.log(\"connect device: \" + this.dev.manufacturerName + \" \" + this.dev.productName)\r\n\r\n        // resolve interfaces\r\n        if (this.dev.deviceVersionMajor == 42) {\r\n            for (const iface of this.dev.configuration.interfaces) {\r\n                const alt = iface.alternates[0]\r\n                if (alt.interfaceClass == 0xff && alt.interfaceSubclass == 42) {\r\n                    this.iface = iface;\r\n                    this.altIface = alt;\r\n                    break;\r\n                }\r\n            }\r\n        }\r\n\r\n        if (!this.iface) throw new Error(\"HF2 interface not found\")\r\n\r\n        await this.dev.open()\r\n        await this.dev.selectConfiguration(1)\r\n\r\n        if (this.altIface.endpoints.length) {\r\n            this.epIn = this.altIface.endpoints.filter(e => e.direction == \"in\")[0]\r\n            this.epOut = this.altIface.endpoints.filter(e => e.direction == \"out\")[0]\r\n            U.assert(this.epIn.packetSize == 64);\r\n            U.assert(this.epOut.packetSize == 64);\r\n        }\r\n        this.log(\"claim interface\")\r\n        await this.dev.claimInterface(this.iface.interfaceNumber)\r\n        this.log(\"all connected\")\r\n        this.ready = true\r\n        this.readLoop()\r\n    }\r\n}\r\n\r\nexport class Proto {\r\n    eventHandlers: U.SMap<(buf: Uint8Array) => void> = {}\r\n    msgs = new U.PromiseBuffer<Uint8Array>()\r\n    cmdSeq = (Math.random() * 0xffff) | 0;\r\n    private lock = new U.PromiseQueue();\r\n\r\n    constructor(public io: Transport) {\r\n        let frames: Uint8Array[] = []\r\n\r\n        io.onData = buf => {\r\n            let tp = buf[0] & HF2_FLAG_MASK\r\n            let len = buf[0] & 63\r\n            //console.log(`msg tp=${tp} len=${len}`)\r\n            let frame = new Uint8Array(len)\r\n            U.memcpy(frame, 0, buf, 1, len)\r\n            if (tp & HF2_FLAG_SERIAL_OUT) {\r\n                this.onSerial(frame, tp == HF2_FLAG_SERIAL_ERR)\r\n                return\r\n            }\r\n            frames.push(frame)\r\n            if (tp == HF2_FLAG_CMDPKT_BODY) {\r\n                return\r\n            } else {\r\n                U.assert(tp == HF2_FLAG_CMDPKT_LAST)\r\n                let total = 0\r\n                for (let f of frames) total += f.length\r\n                let r = new Uint8Array(total)\r\n                let ptr = 0\r\n                for (let f of frames) {\r\n                    U.memcpy(r, ptr, f)\r\n                    ptr += f.length\r\n                }\r\n                frames = []\r\n                if (r[2] & HF2_STATUS_EVENT) {\r\n                    // asynchronous event\r\n                    this.handleEvent(r)\r\n                } else {\r\n                    this.msgs.push(r)\r\n                }\r\n            }\r\n        }\r\n    }\r\n\r\n\r\n    error(m: string) {\r\n        return this.io.error(m)\r\n    }\r\n\r\n    talkAsync(cmd: number, data?: Uint8Array) {\r\n        let len = 8\r\n        if (data) len += data.length\r\n        let pkt = new Uint8Array(len)\r\n        let seq = ++this.cmdSeq & 0xffff\r\n        U.write32(pkt, 0, cmd);\r\n        U.write16(pkt, 4, seq);\r\n        U.write16(pkt, 6, 0);\r\n        if (data)\r\n            U.memcpy(pkt, 8, data, 0, data.length)\r\n        let numSkipped = 0\r\n        let handleReturnAsync = (): Promise<Uint8Array> =>\r\n            this.msgs.shiftAsync(1000) // we wait up to a second\r\n                .then(res => {\r\n                    if (U.read16(res, 0) != seq) {\r\n                        if (numSkipped < 3) {\r\n                            numSkipped++\r\n                            this.io.log(`message out of sync, (${seq} vs ${U.read16(res, 0)}); will re-try`)\r\n                            return handleReturnAsync()\r\n                        }\r\n                        this.error(\"out of sync\")\r\n                    }\r\n                    let info = \"\"\r\n                    if (res[3])\r\n                        info = \"; info=\" + res[3]\r\n                    switch (res[2]) {\r\n                        case HF2_STATUS_OK:\r\n                            return res.slice(4)\r\n                        case HF2_STATUS_INVALID_CMD:\r\n                            this.error(\"invalid command\" + info)\r\n                            break\r\n                        case HF2_STATUS_EXEC_ERR:\r\n                            this.error(\"execution error\" + info)\r\n                            break\r\n                        default:\r\n                            this.error(\"error \" + res[2] + info)\r\n                            break\r\n                    }\r\n                    return null\r\n                })\r\n\r\n        return this.lock.enqueue(\"talk\", () =>\r\n            this.sendMsgAsync(pkt)\r\n                .then(handleReturnAsync))\r\n    }\r\n\r\n\r\n    private sendMsgAsync(buf: Uint8Array, serial: number = 0) {\r\n        // Util.assert(buf.length <= this.maxMsgSize)\r\n        let frame = new Uint8Array(64)\r\n        let loop = (pos: number): Promise<void> => {\r\n            let len = buf.length - pos\r\n            if (len <= 0) return Promise.resolve()\r\n            if (len > 63) {\r\n                len = 63\r\n                frame[0] = HF2_FLAG_CMDPKT_BODY;\r\n            } else {\r\n                frame[0] = HF2_FLAG_CMDPKT_LAST;\r\n            }\r\n            if (serial) frame[0] = serial == 1 ? HF2_FLAG_SERIAL_OUT : HF2_FLAG_SERIAL_ERR;\r\n            frame[0] |= len;\r\n            for (let i = 0; i < len; ++i)\r\n                frame[i + 1] = buf[pos + i]\r\n            return this.io.sendPacketAsync(frame)\r\n                .then(() => loop(pos + len))\r\n        }\r\n        return loop(0)\r\n    }\r\n\r\n    onEvent(id: number, f: (buf: Uint8Array) => void) {\r\n        U.assert(!!(id & HF2_EV_MASK))\r\n        this.eventHandlers[id + \"\"] = f\r\n    }\r\n\r\n    onJDMessage(f: (buf: Uint8Array) => void) {\r\n        this.talkAsync(HF2_CMD_JDS_CONFIG, U.encodeU32LE([1]))\r\n        this.onEvent(HF2_EV_JDS_PACKET, f)\r\n    }\r\n\r\n    sendJDMessageAsync(buf: Uint8Array) {\r\n        return this.talkAsync(HF2_CMD_JDS_SEND, buf)\r\n    }\r\n\r\n    handleEvent(buf: Uint8Array) {\r\n        let evid = U.read32(buf, 0)\r\n        let f = this.eventHandlers[evid + \"\"]\r\n        if (f) {\r\n            f(buf.slice(4))\r\n        } else {\r\n            this.io.log(\"unhandled event: \" + evid.toString(16))\r\n        }\r\n    }\r\n    onSerial(data: Uint8Array, iserr: boolean) {\r\n        console.log(\"SERIAL:\", U.bufferToString(data))\r\n    }\r\n\r\n    async init() {\r\n        await this.io.init()\r\n        const buf = await this.talkAsync(HF2_CMD_INFO)\r\n        this.io.log(\"Connected to: \" + U.bufferToString(buf))\r\n    }\r\n}\r\n","import * as U from \"./utils\"\r\nimport * as jd from \"./constants\"\r\nimport { Packet } from \"./packet\"\r\n\r\nconst service_classes: U.SMap<number> = {\r\n    \"<disabled>\": -1,\r\n    CTRL: 0,\r\n    LOGGER: 0x12dc1fca,\r\n    BATTERY: 0x1d2a2acd,\r\n    ACCELEROMETER: 0x1f140409,\r\n    BUTTON: 0x1473a263,\r\n    TOUCHBUTTON: 0x130cf5be,\r\n    LIGHT_SENSOR: 0x15e7a0ff,\r\n    MICROPHONE: 0x1a5c5866,\r\n    THERMOMETER: 0x1421bac7,\r\n    SWITCH: 0x14218172,\r\n    PIXEL: 0x1768fbbf,\r\n    HAPTIC: 0x116b14a3,\r\n    LIGHT: 0x126f00e0,\r\n    KEYBOARD: 0x1ae4812d,\r\n    MOUSE: 0x14bc97bf,\r\n    GAMEPAD: 0x100527e8,\r\n    MUSIC: 0x1b57b1d7,\r\n    SERVO: 0x12fc9103,\r\n    CONTROLLER: 0x188ae4b8,\r\n    LCD: 0x18d5284c,\r\n    MESSAGE_BUS: 0x115cabf5,\r\n    COLOR_SENSOR: 0x14d6dda2,\r\n    LIGHT_SPECTRUM_SENSOR: 0x16fa0c0d,\r\n    PROXIMITY: 0x14c1791b,\r\n    TOUCH_BUTTONS: 0x1acb49d5,\r\n    SERVOS: 0x182988d8,\r\n    ROTARY_ENCODER: 0x10fa29c9,\r\n    DNS: 0x117729bd,\r\n    PWM_LIGHT: 0x1fb57453,\r\n    BOOTLOADER: 0x1ffa9948,\r\n    ARCADE_CONTROLS: 0x1deaa06e,\r\n    POWER: 0x1fa4c95a,\r\n    SLIDER: 0x1f274746,\r\n    MOTOR: 0x17004cd8,\r\n    TCP: 0x1b43b70b,\r\n    WIFI: 0x18aae1fa,\r\n}\r\n\r\nconst generic_commands: U.SMap<number> = {\r\n    CMD_ADVERTISEMENT_DATA: 0x00,\r\n    CMD_EVENT: 0x01,\r\n    CMD_CALIBRATE: 0x02,\r\n    CMD_GET_DESCRIPTION: 0x03,\r\n    /*\r\n    CMD_CTRL_NOOP: 0x80,\r\n    CMD_CTRL_IDENTIFY: 0x81,\r\n    CMD_CTRL_RESET: 0x82,\r\n    */\r\n}\r\n\r\nconst generic_regs: U.SMap<number> = {\r\n    REG_INTENSITY: 0x01,\r\n    REG_VALUE: 0x02,\r\n    REG_IS_STREAMING: 0x03,\r\n    REG_STREAMING_INTERVAL: 0x04,\r\n    REG_LOW_THRESHOLD: 0x05,\r\n    REG_HIGH_THRESHOLD: 0x06,\r\n    REG_MAX_POWER: 0x07,\r\n    REG_READING: 0x101\r\n}\r\n\r\nconst serv_decoders: U.SMap<(p: Packet) => string> = {\r\n    LOGGER: (pkt: Packet) => {\r\n        const pri = priority()\r\n        if (!pri) return null\r\n        return `${pri} \"${U.bufferToString(pkt.data)}\"`\r\n\r\n        function priority() {\r\n            switch (pkt.service_command) {\r\n                case 0x80: return \"dbg\"\r\n                case 0x81: return \"log\"\r\n                case 0x82: return \"warn\"\r\n                case 0x83: return \"err\"\r\n                default: return null\r\n            }\r\n        }\r\n    }\r\n}\r\n\r\nfunction reverseLookup(map: U.SMap<number>, n: number) {\r\n    for (let k of Object.keys(map)) {\r\n        if (map[k] == n)\r\n            return k\r\n    }\r\n    return toHex(n)\r\n}\r\n\r\nfunction serviceName(n: number) {\r\n    if (n == null)\r\n        return \"?\"\r\n    return reverseLookup(service_classes, n)\r\n}\r\n\r\nfunction commandName(n: number) {\r\n    let pref = \"\"\r\n    if ((n & jd.CMD_TOP_MASK) == jd.CMD_SET_REG) pref = \"SET[\"\r\n    else if ((n & jd.CMD_TOP_MASK) == jd.CMD_GET_REG) pref = \"GET[\"\r\n    if (pref) {\r\n        const reg = n & jd.CMD_REG_MASK\r\n        return pref + reverseLookup(generic_regs, reg) + \"]\"\r\n    }\r\n    return reverseLookup(generic_commands, n)\r\n}\r\n\r\n\r\nfunction toHex(n: number) {\r\n    return \"0x\" + n.toString(16)\r\n}\r\n\r\n\r\nfunction num2str(n: number) {\r\n    return n + \" (0x\" + n.toString(16) + \")\"\r\n}\r\n\r\nexport interface Options {\r\n    skipRepeatedAnnounce?: boolean;\r\n    skipRepeatedReading?: boolean;\r\n}\r\n\r\nexport function printPacket(pkt: Packet, opts: Options = {}): string {\r\n    const frame_flags = pkt._header[3]\r\n\r\n    let devname = pkt.dev ? pkt.dev.name || pkt.dev.shortId : pkt.device_identifier\r\n\r\n    if (frame_flags & jd.JD_FRAME_FLAG_IDENTIFIER_IS_SERVICE_CLASS)\r\n        devname = \"[mul] \" + serviceName(pkt.multicommand_class)\r\n\r\n    const serv_id = serviceName(pkt?.dev?.serviceAt(pkt.service_number))\r\n    let service_name = `${serv_id} (${pkt.service_number})`\r\n    const cmd = pkt.service_command\r\n    let cmdname = commandName(cmd)\r\n    if (pkt.service_number == jd.JD_SERVICE_NUMBER_CRC_ACK) {\r\n        service_name = \"CRC-ACK\"\r\n        cmdname = toHex(cmd)\r\n    }\r\n    if (pkt.service_number == jd.JD_SERVICE_NUMBER_STREAM) {\r\n        service_name = \"STREAM\"\r\n        cmdname = `port:${cmd >> jd.STREAM_PORT_SHIFT} cnt:${cmd & jd.STREAM_COUNTER_MASK}`\r\n        if (cmd & jd.STREAM_METADATA_MASK)\r\n            cmdname += \" meta\"\r\n        if (cmd & jd.STREAM_CLOSE_MASK)\r\n            cmdname += \" close\"\r\n    }\r\n\r\n    let pdesc = `${devname}/${service_name}: ${cmdname}; sz=${pkt.size}`\r\n\r\n    if (frame_flags & jd.JD_FRAME_FLAG_COMMAND)\r\n        pdesc = 'to ' + pdesc\r\n    else\r\n        pdesc = 'from ' + pdesc\r\n    if (frame_flags & jd.JD_FRAME_FLAG_ACK_REQUESTED)\r\n        pdesc = `[ack:${toHex(pkt.crc)}] ` + pdesc\r\n\r\n    const d = pkt.data\r\n    if (pkt.dev && pkt.service_number == 0 && pkt.service_command == jd.CMD_ADVERTISEMENT_DATA) {\r\n        if (pkt.dev.lastServiceUpdate < pkt.timestamp) {\r\n            if (opts.skipRepeatedAnnounce)\r\n                return \"\"\r\n            else\r\n                pdesc = \" ====== \" + pdesc\r\n        } else {\r\n            const services = []\r\n            for (let i = 0; i < pkt.dev.services.length >> 2; i++) {\r\n                services.push(serviceName(pkt.dev.serviceAt(i)))\r\n            }\r\n            pdesc += \"; \" + \"Announce services: \" + services.join(\", \")\r\n        }\r\n    } else {\r\n        if (pkt.dev && !pkt.is_command && pkt.service_command == (jd.CMD_GET_REG | jd.REG_READING)) {\r\n            if (opts.skipRepeatedReading && pkt.dev.currentReading && U.bufferEq(pkt.dev.currentReading, pkt.data))\r\n                return \"\"\r\n            pkt.dev.currentReading = pkt.data\r\n        }\r\n\r\n        const decoder = serv_decoders[serv_id]\r\n        const decoded = decoder ? decoder(pkt) : null\r\n        if (decoded) {\r\n            pdesc += \"; \" + decoded\r\n        } else if (pkt.service_command == jd.CMD_EVENT) {\r\n            pdesc += \"; ev=\" + num2str(pkt.intData) + \" arg=\" + (U.read32(pkt.data, 4) | 0)\r\n        } else if (0 < d.length && d.length <= 4) {\r\n            let v0 = pkt.uintData, v1 = pkt.intData\r\n            pdesc += \"; \" + num2str(v0)\r\n            if (v0 != v1)\r\n                pdesc += \"; signed: \" + num2str(v1)\r\n        } else if (d.length) {\r\n            pdesc += \"; \" + U.toHex(d)\r\n        }\r\n    }\r\n\r\n    return Math.round(pkt.timestamp) + \"ms: \" + pdesc\r\n}\r\n\r\nexport interface ParsedFrame {\r\n    timestamp: number\r\n    data: Uint8Array\r\n    info?: string\r\n}\r\n\r\nexport function parseLog(logcontents: string) {\r\n    const res: ParsedFrame[] = []\r\n    let frameBytes = []\r\n    let lastTime = 0\r\n    for (let ln of logcontents.split(/\\r?\\n/)) {\r\n        let m = /^JD (\\d+) ([0-9a-f]+)/i.exec(ln)\r\n        if (m) {\r\n            res.push({\r\n                timestamp: parseInt(m[1]),\r\n                data: U.fromHex(m[2])\r\n            })\r\n            continue\r\n        }\r\n\r\n        m = /^([\\d\\.]+),Async Serial,.*(0x[A-F0-9][A-F0-9])/.exec(ln)\r\n        if (!m)\r\n            continue\r\n        const tm = parseFloat(m[1])\r\n        if (lastTime && tm - lastTime > 0.1) {\r\n            res.push({\r\n                timestamp: lastTime * 1000,\r\n                data: new Uint8Array(frameBytes),\r\n                info: \"timeout\"\r\n            })\r\n            frameBytes = []\r\n            lastTime = 0\r\n        }\r\n\r\n        lastTime = tm\r\n        if (ln.indexOf(\"framing error\") > 0) {\r\n            if (frameBytes.length > 0)\r\n                res.push({\r\n                    timestamp: lastTime * 1000,\r\n                    data: new Uint8Array(frameBytes),\r\n                })\r\n            frameBytes = []\r\n            lastTime = 0\r\n        } else {\r\n            frameBytes.push(parseInt(m[2]))\r\n        }\r\n    }\r\n\r\n    return res\r\n}\r\n\r\n"],"names":["U.delay","U.assert","U.PromiseBuffer","U.PromiseQueue","U.memcpy","U.write32","U.write16","U.read16","U.encodeU32LE","U.read32","U.bufferToString","toHex","jd.CMD_TOP_MASK","jd.CMD_SET_REG","jd.CMD_GET_REG","jd.CMD_REG_MASK","jd.JD_FRAME_FLAG_IDENTIFIER_IS_SERVICE_CLASS","jd.JD_SERVICE_NUMBER_CRC_ACK","jd.JD_SERVICE_NUMBER_STREAM","jd.STREAM_PORT_SHIFT","jd.STREAM_COUNTER_MASK","jd.STREAM_METADATA_MASK","jd.STREAM_CLOSE_MASK","jd.JD_FRAME_FLAG_COMMAND","jd.JD_FRAME_FLAG_ACK_REQUESTED","jd.CMD_ADVERTISEMENT_DATA","jd.REG_READING","U.bufferEq","jd.CMD_EVENT","U.toHex","U.fromHex"],"mappings":"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"}